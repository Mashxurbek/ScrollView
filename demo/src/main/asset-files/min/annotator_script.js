var Annotator=function(a){this.options=a||{};this.options.className&&(this.options.blacklist||(this.options.blacklist=[]),this.options.blacklist.push("."+this.options.className));this.selection={};this.xpath=new XPath(this.options.rootNode,this.options.blacklist);this.highlighter=new Highlighter(this.options);this.validationHooks=[];this.validationHandler=null};Annotator.SELECTION_CHANGE_EVENT_NAME="selectionchange";Annotator.MAXIMUM_HIGHLIGHT_LENGTH=750;
Annotator.HIGHLIGHT_MAXIMUM_LENGTH_EXCEEDED_MESSAGE="This highlight is too large.";
Annotator.prototype={addValidationHook:function(a){this.validationHooks.push(a)},setValidationHandler:function(a){this.validationHandler=a},validate:function(){this.isValid=!0;this.validationHooks.forEach(function(a){try{a(this.selection)}catch(b){this.isValid=!1,this.validationHandler(b)}},this)},options:null,selection:null,handler:null,xpath:null,highlighter:null,highlightRange:function(a,b){var c=this.highlighter.highlightRange(a),d=!b;c.forEach(function(a){b&&(a.classList.add(this.options.noteClassName),
d||(a.classList.add(this.options.leadClassName),d=!0))},this);return c},clear:function(){this.highlighter.clearAll()},getRangeDescriptorFromSelection:function(){var a=Dom.getFirstAncestorOutsideOfProhibitedTree(this.selection.anchorNode,this.options.blacklist),b=Dom.getFirstAncestorOutsideOfProhibitedTree(this.selection.focusNode,this.options.blacklist),c=this.selection.anchorOffset,d=this.selection.focusOffset;a!=this.selection.anchorNode&&(c+=Dom.getOffsetToNode(this.selection.anchorNode,a));b!=
this.selection.focusNode&&(d+=Dom.getOffsetToNode(this.selection.focusNode,b));return{start:this.xpath.write(a),startOffset:c,end:this.xpath.write(b),endOffset:d}},onSelectionChange:function(a){a=window.getSelection();if(null!=a&&a.rangeCount)if(a.toString().length>Annotator.MAXIMUM_HIGHLIGHT_LENGTH)this.selection.exception=Annotator.HIGHLIGHT_MAXIMUM_LENGTH_EXCEEDED_MESSAGE;else{this.selection.exception=null;var b=a.getRangeAt(0);this.selection.anchorNode=b.startContainer;this.selection.anchorOffset=
b.startOffset;this.selection.anchorNode.nodeType==Node.ELEMENT_NODE&&(this.selection.anchorNode=this.selection.anchorNode.childNodes[this.selection.anchorOffset],this.selection.anchorOffset=0);this.selection.focusNode=b.endContainer;this.selection.focusOffset=b.endOffset;this.selection.focusNode.nodeType==Node.ELEMENT_NODE&&0<this.selection.focusNode.childNodes.length&&(this.selection.focusNode=this.selection.focusNode.childNodes[this.selection.focusOffset],this.selection.focusOffset=0);var b=b.cloneContents(),
c=document.createElement("div");c.appendChild(b);this.selection.fragment=c.innerHTML;this.selection.quote=a.toString();(this.selection.anchorNode==this.selection.focusNode?this.selection.anchorOffset<this.selection.focusOffset:Dom.isBefore(this.options.rootNode,this.selection.anchorNode,this.selection.focusNode))||(a=this.selection.anchorNode,b=this.selection.anchorOffset,this.selection.anchorNode=this.selection.focusNode,this.selection.focusNode=a,this.selection.anchorOffset=this.selection.focusOffset,
this.selection.focusOffset=b)}},start:function(){this.handler=this.onSelectionChange.bind(this);document.addEventListener(Annotator.SELECTION_CHANGE_EVENT_NAME,this.handler)},stop:function(){document.removeEventListener(Annotator.SELECTION_CHANGE_EVENT_NAME,this.handler);this.handler=null}};